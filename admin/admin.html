<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="background"></div>
    <div class="login-container" id="login-container">
        <h1>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h1>
        <form id="login-form">
            <div class="input-group">
                <label for="username">–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="input-group">
                <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">–í–æ–π—Ç–∏</button>
        </form>
        <p id="error-message" style="color: red; display: none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!</p>
    </div>

    <div class="admin-container" id="admin-container" style="display: none;">
        <div class="admin-header">
            <h1>–ó–∞–∫–∞–∑—ã</h1>
            <button id="refresh-button" class="refresh-button">
                <span class="refresh-icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
        <div class="table-wrapper">
            <table id="orders-table">
                <thead>
                    <tr>
                        <th>–ò–º—è</th>
                        <th>Discord</th>
                        <th>Email</th>
                        <th>–ó–∞–∫–∞–∑</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                        <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                        <th>–î–∞—Ç–∞</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- –°—é–¥–∞ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –∑–∞–∫–∞–∑—ã -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const adminContainer = document.getElementById('admin-container');
            const loginForm = document.getElementById('login-form');
            const errorMessage = document.getElementById('error-message');
            const loader = document.getElementById('loader');
            const refreshButton = document.getElementById('refresh-button');

            // –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ö–µ—à–∏ –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è
            const ADMIN_USERNAME_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";
            const ADMIN_PASSWORD_HASH = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9";

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è SHA-256
            async function hashSHA256(text) {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const hashBuffer = await crypto.subtle.digest("SHA-256", data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(byte => byte.toString(16).padStart(2, "0")).join("");
            }

            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            loginForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                loader.style.display = "flex";

                const username = document.getElementById("username").value;
                const password = document.getElementById("password").value;

                try {
                    const hashedUsername = await hashSHA256(username);
                    const hashedPassword = await hashSHA256(password);

                    if (hashedUsername === ADMIN_USERNAME_HASH && hashedPassword === ADMIN_PASSWORD_HASH) {
                        loginContainer.style.display = "none";
                        adminContainer.style.display = "block";
                        await loadOrders();
                    } else {
                        errorMessage.style.display = "block";
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
                    alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
                } finally {
                    loader.style.display = "none";
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
            async function loadOrders() {
                loader.style.display = "flex";
                try {
                    const response = await fetch('https://9b9t.shop:8443/api/orders');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const orders = await response.json();
                    renderOrders(orders);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:", error);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã");
                } finally {
                    loader.style.display = "none";
                }
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
            function renderOrders(orders) {
                const tbody = document.querySelector('#orders-table tbody');
                tbody.innerHTML = '';

                orders.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.username}</td>
                        <td>${order.discord}</td>
                        <td>${order.email}</td>
                        <td>${order.order.map(item => `
                            ${item.name} x${item.quantity} ($${item.price})
                        `).join('<br>')}</td>
                        <td>$${order.total.toFixed(2)}</td>
                        <td>${order.deliveryMethod === 'specific' ? '–ü–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º' : '–†–∞–Ω–¥–æ–º–Ω–∞—è'}</td>
                        <td>${order.coordinates ? 
                            `X: ${order.coordinates.x}<br>Y: ${order.coordinates.y}<br>Z: ${order.coordinates.z}` 
                            : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td>
                        <td>${order.date}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
            refreshButton.addEventListener('click', async () => {
                await loadOrders();
            });
        });
    </script>
</body>
</html>
